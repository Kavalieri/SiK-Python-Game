# Plan de Migraci√≥n a SQLite - SiK Python Game

## üîó Referencias Cruzadas Actualizadas
- **Documento Central**: [`docs/REFACTORIZACION_ESTADO_ACTUAL.md`](./REFACTORIZACION_ESTADO_ACTUAL.md) - Estado actualizado sin redundancias
- **Funciones Catalogadas**: [`docs/FUNCIONES_DOCUMENTADAS.md`](./FUNCIONES_DOCUMENTADAS.md) - Funciones por m√≥dulo
- **Proyecto SQLite**: [`docs/PROYECTO_MIGRACION_SQLITE.md`](./PROYECTO_MIGRACION_SQLITE.md) - Plan ejecutivo del proyecto
- **Instrucciones Base**: [`.github/copilot-instructions.md`](../.github/copilot-instructions.md) - Reglas del proyecto

## üéØ CAMBIO DE PRIORIDAD: SQLite y Eliminaci√≥n de Hardcodeo

### üö® Problema Cr√≠tico Identificado
El proyecto tiene **duplicaciones masivas** entre configuraci√≥n JSON y c√≥digo hardcodeado que requieren un **sistema mixto inteligente**:
- **characters.json** (189 l√≠neas, 4,875 caracteres) ‚Üî **character_data.py** (152 l√≠neas) ‚Üí **MIGRAR A SQLite**
- **enemies.json** (73 l√≠neas, 1,901 caracteres) ‚Üî **enemy_types.py** (230 l√≠neas) ‚Üí **MIGRAR A SQLite**
- **powerups.json** (106 l√≠neas, 2,780 caracteres) ‚Üî **powerup.py** (161 l√≠neas) ‚Üí **SEPARAR**: config JSON + l√≥gica Python
- **gameplay.json** (34 l√≠neas, 769 caracteres) ‚Üî M√∫ltiples archivos de escenas ‚Üí **MANTENER JSON**, eliminar hardcodeo
- **audio.json** (32 l√≠neas, 969 caracteres) ‚Üî M√≥dulos de audio ‚Üí **MANTENER JSON**, usar configuraci√≥n

### ‚ö° Nueva Estrategia: Sistema Mixto Inteligente
1. **SQLite para datos complejos**: Partidas, personajes, enemigos, estad√≠sticas
2. **Archivos JSON para configuraci√≥n**: Variables modificables, configuraci√≥n de usuario
3. **Eliminar hardcodeo**: Separar l√≥gica de configuraci√≥n completamente
4. **Optimizaci√≥n posterior**: Solo despu√©s de funcionalidad operativa

## ÔøΩüìã Estado Actual de Persistencia

### Sistemas Identificados
1. **SaveManager** (365 l√≠neas) - Cr√≠tico para refactorizaci√≥n
   - Formato: pickle + zlib + XOR encryption
   - 3 slots de guardado (slot_1.save, slot_2.save, slot_3.save)
   - Metadata con timestamp y descripci√≥n
   - Encriptaci√≥n personalizada

2. **ConfigManager** (264 l√≠neas) - Cr√≠tico para refactorizaci√≥n
   - Configuraciones modulares en JSON
   - Archivos: characters.json, enemies.json, gameplay.json, etc.
   - Sistema de validaci√≥n y carga din√°mica

3. **GameState** (151 l√≠neas) - L√≠mite excedido
   - Gesti√≥n de estado de juego en tiempo real
   - Score, vidas, nivel, configuraciones
   - Referencias a jugador y entidades

## üóÑÔ∏è Esquema SQLite Propuesto

### Tabla 1: partidas_guardadas
```sql
CREATE TABLE partidas_guardadas (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    slot INTEGER NOT NULL CHECK(slot IN (1, 2, 3)),
    nombre_jugador TEXT NOT NULL,
    descripcion TEXT,
    nivel_actual INTEGER DEFAULT 1,
    puntuacion INTEGER DEFAULT 0,
    vidas INTEGER DEFAULT 3,
    tiempo_jugado INTEGER DEFAULT 0, -- segundos
    personaje TEXT NOT NULL, -- 'guerrero', etc.
    estado_juego TEXT, -- JSON serializado del estado completo
    creado_en DATETIME DEFAULT CURRENT_TIMESTAMP,
    actualizado_en DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(slot)
);
```

### Tabla 2: configuraciones
```sql
CREATE TABLE configuraciones (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    categoria TEXT NOT NULL, -- 'audio', 'display', 'input', etc.
    clave TEXT NOT NULL,
    valor TEXT NOT NULL, -- JSON para objetos complejos
    tipo TEXT NOT NULL CHECK(tipo IN ('string', 'number', 'boolean', 'object')),
    descripcion TEXT,
    actualizado_en DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(categoria, clave)
);
```

### Tabla 3: personajes
```sql
CREATE TABLE personajes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    nombre TEXT UNIQUE NOT NULL, -- 'guerrero', etc.
    nombre_mostrar TEXT NOT NULL, -- 'Kava'
    tipo TEXT NOT NULL, -- 'Melee', 'Ranged'
    descripcion TEXT,
    stats TEXT NOT NULL, -- JSON: vida, velocidad, da√±o, etc.
    ataques TEXT NOT NULL, -- JSON array de ataques
    sprite_config TEXT, -- JSON: rutas de sprites y animaciones
    activo BOOLEAN DEFAULT 1,
    creado_en DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### Tabla 4: enemigos
```sql
CREATE TABLE enemigos (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    tipo TEXT UNIQUE NOT NULL, -- 'zombie_male', 'zombie_female'
    nombre_mostrar TEXT NOT NULL,
    stats TEXT NOT NULL, -- JSON: vida, velocidad, da√±o, rangos
    comportamiento TEXT NOT NULL, -- 'perseguir', 'patrullar'
    animaciones TEXT NOT NULL, -- JSON: idle, walk, attack, dead
    variantes TEXT, -- JSON: normal, raro, √©lite, legendario
    activo BOOLEAN DEFAULT 1,
    creado_en DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### Tabla 5: estadisticas_juego
```sql
CREATE TABLE estadisticas_juego (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    slot_partida INTEGER NOT NULL,
    tipo_estadistica TEXT NOT NULL, -- 'enemigos_eliminados', 'disparos_acertados', etc.
    valor INTEGER NOT NULL,
    sesion_id TEXT, -- UUID para agrupar estad√≠sticas por sesi√≥n
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (slot_partida) REFERENCES partidas_guardadas(slot)
);
```

### Tabla 6: configuracion_gameplay
```sql
CREATE TABLE configuracion_gameplay (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    categoria TEXT NOT NULL, -- 'niveles', 'combate', 'powerups', 'puntuaci√≥n'
    configuracion TEXT NOT NULL, -- JSON completo de la categor√≠a
    version INTEGER DEFAULT 1,
    activo BOOLEAN DEFAULT 1,
    actualizado_en DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

## üîÑ Plan de Migraci√≥n en Fases - CHECKLIST

### ‚úÖ FASE 1: Infraestructura SQLite (COMPLETADA ‚úÖ)
**Objetivo**: Base SQLite funcional sin romper sistema actual
**Estado**: Sistema modular implementado y funcional

#### Componentes Implementados:
- [x] **DatabaseManager** (169 l√≠neas) - Gestor principal ‚úÖ
- [x] **SchemaManager** (169 l√≠neas) - Manager de esquemas ‚úÖ
- [x] **SchemaCore** (164 l√≠neas) - N√∫cleo del sistema ‚úÖ
- [x] **SchemaTables** (160 l√≠neas) - Definiciones de tablas ‚úÖ
- [x] **SchemaMigrations** (171 l√≠neas) - Sistema de migraciones ‚úÖ

#### Funcionalidades Operativas:
- [x] Connection pooling SQLite optimizado
- [x] Sistema completo de tablas definido
- [x] Migraciones autom√°ticas de esquema
- [x] Validaci√≥n de integridad
- [x] Backup autom√°tico antes de cambios
- [x] Testing b√°sico completado (`scripts/test_simple_sqlite.py`)

**üìä RESULTADO**: Infraestructura SQLite lista para migraci√≥n de datos

### üî• FASE 2: Migraci√≥n de Configuraciones (EN PROCESO)
**Objetivo**: Migrar JSON hardcodeado a SQLite como fuente √∫nica
**Prioridad**: CR√çTICA - Eliminar duplicaciones masivas

#### üìä Duplicaciones Identificadas:
1. **characters.json** (189 l√≠neas) ‚Üî **character_data.py** (152 l√≠neas)
   - **Problema**: Datos id√©nticos en dos formatos diferentes
   - **Soluci√≥n**: SQLite como fuente √∫nica, eliminar character_data.py
   - **Impacto**: 4,875 caracteres de configuraci√≥n vs c√≥digo hardcodeado

2. **enemies.json** (73 l√≠neas) ‚Üî **enemy_types.py** (230 l√≠neas)
   - **Problema**: Inconsistencias cr√≠ticas entre JSON y c√≥digo
   - **Soluci√≥n**: Migrar a tabla `enemigos`, usar solo SQLite
   - **Impacto**: 1,901 caracteres JSON vs 230 l√≠neas Python

3. **powerups.json** (106 l√≠neas) ‚Üî **powerup.py** (161 l√≠neas)
   - **Problema**: Duplicaci√≥n parcial con l√≥gica mezclada
   - **Soluci√≥n**: Separar configuraci√≥n (SQLite) de l√≥gica (Python)
   - **Impacto**: 2,780 caracteres de configuraci√≥n

#### ‚ö° Plan de Implementaci√≥n Inmediata:

##### PASO 1: Sistema Mixto Inteligente (INMEDIATO)
- [ ] **Implementar ConfigDatabase** - Nueva interfaz SQLite para datos complejos
- [ ] **Migrar characters.json ‚Üí tabla personajes** (eliminar character_data.py hardcodeado)
- [ ] **Migrar enemies.json ‚Üí tabla enemigos** (eliminar enemy_types.py hardcodeado)
- [ ] **Mantener powerups.json** como configuraci√≥n, eliminar hardcodeo en powerup.py
- [ ] **Mantener gameplay.json** como configuraci√≥n, eliminar valores hardcodeados en escenas
- [ ] **Sistema de compatibilidad** durante la transici√≥n

##### PASO 2: Eliminaci√≥n de Hardcodeo (1-2 d√≠as)
- [ ] **Modificar character_data.py** - Leer desde SQLite en lugar de diccionario hardcodeado
- [ ] **Refactorizar enemy_types.py** - Usar tabla SQLite enemigos
- [ ] **Actualizar powerup.py** - Separar completamente l√≥gica de configuraci√≥n JSON
- [ ] **Actualizar escenas de juego** - Usar gameplay.json en lugar de valores hardcodeados
- [ ] **Testing completo** - Verificar funcionalidad id√©ntica con nuevo sistema

##### PASO 3: Sistema Unificado (2-3 d√≠as)
- [ ] **API h√≠brida de configuraci√≥n** - ConfigManager que use SQLite + JSON seg√∫n corresponda
- [ ] **Documentaci√≥n de criterios** - Cu√°ndo usar SQLite vs JSON
- [ ] **Optimizaci√≥n del sistema** - Cach√© inteligente y performance
- [ ] **Documentaci√≥n actualizada** - Nuevas funciones en FUNCIONES_DOCUMENTADAS.md

### üìä FASE 3: Migraci√≥n del SaveManager (Dividir + Migrar)
**Objetivo**: Reemplazar pickle con SQLite manteniendo encriptaci√≥n
**üìã Referencia**: [Progreso Refactorizaci√≥n - Fase 3](./refactorizacion_progreso.md#fase-3---cr√≠tica)

- [ ] **Dividir SaveManager** en m√≥dulos:
  - [ ] `save_loader.py` (m√°ximo 150 l√≠neas) - Carga/guardado
  - [ ] `save_encryption.py` (m√°ximo 150 l√≠neas) - Encriptaci√≥n XOR
  - [ ] `save_database.py` (m√°ximo 150 l√≠neas) - Interfaz SQLite
  - [ ] `save_compatibility.py` (m√°ximo 150 l√≠neas) - Migraci√≥n desde pickle
  - [ ] Actualizar [FUNCIONES_DOCUMENTADAS.md](./FUNCIONES_DOCUMENTADAS.md)

- [ ] **Proceso de migraci√≥n**:
  - [ ] Migraci√≥n autom√°tica: `migrar_saves_pickle_a_sqlite()`
  - [ ] Mantener compatibilidad con saves antiguos
  - [ ] Encriptar campos sensibles en SQLite

- [ ] **Mejoras en funcionalidad**:
  - [ ] Guardado autom√°tico cada X minutos
  - [ ] Historial de partidas por slot
  - [ ] Estad√≠sticas detalladas por sesi√≥n
  - [ ] Backup autom√°tico preparado para futuro
  - [ ] Actualizar [refactorizacion_progreso.md](./refactorizacion_progreso.md)

### ‚ö° FASE 4: Migraci√≥n del GameState (Refactorizar + Integrar)
**Objetivo**: Dividir GameState e integrar con SQLite
**üìã Referencia**: [Progreso Refactorizaci√≥n - Archivos Cr√≠ticos](./refactorizacion_progreso.md#archivos-m√°s-cr√≠ticos)

- [ ] **Dividir GameState** en m√≥dulos:
  - [ ] `game_state_core.py` (m√°ximo 150 l√≠neas) - Estado b√°sico
  - [ ] `game_state_persistence.py` (m√°ximo 150 l√≠neas) - Guardado/carga
  - [ ] `game_state_statistics.py` (m√°ximo 150 l√≠neas) - Estad√≠sticas
  - [ ] Actualizar [FUNCIONES_DOCUMENTADAS.md](./FUNCIONES_DOCUMENTADAS.md)

- [ ] **Integraci√≥n con SQLite**:
  - [ ] Estado persistente en `partidas_guardadas`
  - [ ] Estad√≠sticas en tiempo real en `estadisticas_juego`
  - [ ] Sincronizaci√≥n autom√°tica
  - [ ] Finalizar actualizaci√≥n [refactorizacion_progreso.md](./refactorizacion_progreso.md)

## üìä Elementos del Sistema Mixto

### üóÑÔ∏è Migrar a SQLite
- **Partidas guardadas**: nivel, puntuaci√≥n, vidas, tiempo (reemplaza pickle)
- **Datos de personajes**: stats, ataques, animaciones (reemplaza character_data.py hardcodeado)
- **Configuraci√≥n de enemigos**: tipos, comportamientos, stats (reemplaza enemy_types.py hardcodeado)
- **Estad√≠sticas de juego**: enemigos eliminados, disparos, tiempo por sesi√≥n
- **Metadata de partidas**: timestamp, descripci√≥n, slot

### üìÑ Mantener en JSON
- **Configuraci√≥n de usuario**: vol√∫menes, efectos (audio.json)
- **Configuraci√≥n de pantalla**: resoluci√≥n, fullscreen (display.json)
- **Configuraci√≥n de controles**: teclas, sensibilidad (input.json)
- **Balance de gameplay**: timers, multiplicadores, probabilidades (gameplay.json)
- **Configuraci√≥n de powerups**: duraciones, efectos, spawn rates (powerups.json)
- **Configuraci√≥n de UI**: colores, dimensiones, fuentes (ui.json)

### ‚ùå Eliminar Hardcodeo de
- **character_data.py**: Diccionario CHARACTER_DATA ‚Üí usar SQLite
- **enemy_types.py**: Clases hardcodeadas ‚Üí usar SQLite + l√≥gica separada
- **Escenas de juego**: Valores hardcodeados ‚Üí usar gameplay.json
- **M√≥dulos de audio**: Configuraci√≥n hardcodeada ‚Üí usar audio.json
- **Sistemas de powerup**: Stats hardcodeados ‚Üí usar powerups.json

## üîß Herramientas de Migraci√≥n

### Script de Migraci√≥n Autom√°tica
```python
# scripts/migrate_to_sqlite.py
def migrar_todo_a_sqlite():
    """Migraci√≥n completa del sistema actual a SQLite"""
    # Backup completo del estado actual
    crear_backup_completo()

    # Migrar configuraciones
    migrar_configuraciones()

    # Migrar saves existentes
    migrar_saves_existentes()

    # Validar integridad
    validar_migracion()

    # Generar reporte
    generar_reporte_migracion()
```

### Validaciones de Integridad
- Comparar datos migrados vs originales
- Verificar funcionalidad completa post-migraci√≥n
- Tests automatizados de carga/guardado
- Benchmark de rendimiento

## üìà Beneficios de la Migraci√≥n

### Inmediatos
- **Mejor rendimiento**: Queries espec√≠ficos vs carga completa
- **Menor uso de memoria**: Carga selectiva de datos
- **Integridad de datos**: Constraints y validaciones SQL
- **Backup incrementales**: Solo cambios recientes

### A Largo Plazo
- **Analytics avanzados**: Estad√≠sticas detalladas de juego
- **Sincronizaci√≥n**: M√∫ltiples dispositivos (futuro)
- **Modding**: API de base de datos para mods
- **Escalabilidad**: Preparado para multijugador

## üéØ Cronograma Estimado

| Fase | Duraci√≥n | Entregables |
|------|----------|-------------|
| Fase 1 | 2-3 d√≠as | DatabaseManager, SchemaManager, Tests |
| Fase 2 | 3-4 d√≠as | ConfigManager dividido + migrado |
| Fase 3 | 4-5 d√≠as | SaveManager dividido + migrado |
| Fase 4 | 2-3 d√≠as | GameState dividido + integrado |
| **Total** | **11-15 d√≠as** | **Sistema completo migrado** |

## üö® Consideraciones Cr√≠ticas

### Compatibilidad Durante Migraci√≥n
- **Dual-mode**: SQLite + fallback a sistema actual
- **Migraci√≥n gradual**: Funcionalidad por funcionalidad
- **Rollback**: Posibilidad de volver al sistema anterior

### Refactorizaci√≥n Simult√°nea
- **Prioridad 1**: Dividir archivos >150 l√≠neas
- **Prioridad 2**: Migrar datos a SQLite
- **Mantener**: Funcionalidad completa en todo momento

### Backup y Seguridad
- **Backup autom√°tico**: Antes de cada migraci√≥n
- **Encriptaci√≥n**: Mantener XOR para datos sensibles
- **Versionado**: SQLite schema con versiones

---

**‚úÖ PLAN LISTO PARA IMPLEMENTACI√ìN**

Este plan garantiza:
- ‚úÖ Refactorizaci√≥n de archivos cr√≠ticos (SaveManager 365‚Üí4x150 l√≠neas)
- ‚úÖ Migraci√≥n completa de persistencia a SQLite
- ‚úÖ Compatibilidad durante todo el proceso
- ‚úÖ Mejoras significativas en rendimiento y funcionalidad
- ‚úÖ Base s√≥lida para futuras caracter√≠sticas avanzadas

Siguiente paso: ¬øComenzamos con la Fase 1 (DatabaseManager + SchemaManager)?
