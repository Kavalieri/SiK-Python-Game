# Plan de Migraci√≥n a SQLite - SiK Python Game

## ÔøΩ Referencias Cruzadas
- **Documento Central**: [`docs/refactorizacion_progreso.md`](./refactorizacion_progreso.md) - Estado y checklist de refactorizaci√≥n
- **Funciones Catalogadas**: [`docs/FUNCIONES_DOCUMENTADAS.md`](./FUNCIONES_DOCUMENTADAS.md) - Funciones por m√≥dulo
- **√çndice R√°pido**: [`docs/INDICE_MIGRACION_SQLITE.md`](./INDICE_MIGRACION_SQLITE.md) - Vista general del progreso
- **Instrucciones Base**: [`.github/copilot-instructions.md`](../.github/copilot-instructions.md) - Reglas del proyecto

## ÔøΩüìã Estado Actual de Persistencia

### Sistemas Identificados
1. **SaveManager** (365 l√≠neas) - Cr√≠tico para refactorizaci√≥n
   - Formato: pickle + zlib + XOR encryption
   - 3 slots de guardado (slot_1.save, slot_2.save, slot_3.save)
   - Metadata con timestamp y descripci√≥n
   - Encriptaci√≥n personalizada

2. **ConfigManager** (264 l√≠neas) - Cr√≠tico para refactorizaci√≥n
   - Configuraciones modulares en JSON
   - Archivos: characters.json, enemies.json, gameplay.json, etc.
   - Sistema de validaci√≥n y carga din√°mica

3. **GameState** (151 l√≠neas) - L√≠mite excedido
   - Gesti√≥n de estado de juego en tiempo real
   - Score, vidas, nivel, configuraciones
   - Referencias a jugador y entidades

## üóÑÔ∏è Esquema SQLite Propuesto

### Tabla 1: partidas_guardadas
```sql
CREATE TABLE partidas_guardadas (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    slot INTEGER NOT NULL CHECK(slot IN (1, 2, 3)),
    nombre_jugador TEXT NOT NULL,
    descripcion TEXT,
    nivel_actual INTEGER DEFAULT 1,
    puntuacion INTEGER DEFAULT 0,
    vidas INTEGER DEFAULT 3,
    tiempo_jugado INTEGER DEFAULT 0, -- segundos
    personaje TEXT NOT NULL, -- 'guerrero', etc.
    estado_juego TEXT, -- JSON serializado del estado completo
    creado_en DATETIME DEFAULT CURRENT_TIMESTAMP,
    actualizado_en DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(slot)
);
```

### Tabla 2: configuraciones
```sql
CREATE TABLE configuraciones (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    categoria TEXT NOT NULL, -- 'audio', 'display', 'input', etc.
    clave TEXT NOT NULL,
    valor TEXT NOT NULL, -- JSON para objetos complejos
    tipo TEXT NOT NULL CHECK(tipo IN ('string', 'number', 'boolean', 'object')),
    descripcion TEXT,
    actualizado_en DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(categoria, clave)
);
```

### Tabla 3: personajes
```sql
CREATE TABLE personajes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    nombre TEXT UNIQUE NOT NULL, -- 'guerrero', etc.
    nombre_mostrar TEXT NOT NULL, -- 'Kava'
    tipo TEXT NOT NULL, -- 'Melee', 'Ranged'
    descripcion TEXT,
    stats TEXT NOT NULL, -- JSON: vida, velocidad, da√±o, etc.
    ataques TEXT NOT NULL, -- JSON array de ataques
    sprite_config TEXT, -- JSON: rutas de sprites y animaciones
    activo BOOLEAN DEFAULT 1,
    creado_en DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### Tabla 4: enemigos
```sql
CREATE TABLE enemigos (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    tipo TEXT UNIQUE NOT NULL, -- 'zombie_male', 'zombie_female'
    nombre_mostrar TEXT NOT NULL,
    stats TEXT NOT NULL, -- JSON: vida, velocidad, da√±o, rangos
    comportamiento TEXT NOT NULL, -- 'perseguir', 'patrullar'
    animaciones TEXT NOT NULL, -- JSON: idle, walk, attack, dead
    variantes TEXT, -- JSON: normal, raro, √©lite, legendario
    activo BOOLEAN DEFAULT 1,
    creado_en DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### Tabla 5: estadisticas_juego
```sql
CREATE TABLE estadisticas_juego (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    slot_partida INTEGER NOT NULL,
    tipo_estadistica TEXT NOT NULL, -- 'enemigos_eliminados', 'disparos_acertados', etc.
    valor INTEGER NOT NULL,
    sesion_id TEXT, -- UUID para agrupar estad√≠sticas por sesi√≥n
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (slot_partida) REFERENCES partidas_guardadas(slot)
);
```

### Tabla 6: configuracion_gameplay
```sql
CREATE TABLE configuracion_gameplay (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    categoria TEXT NOT NULL, -- 'niveles', 'combate', 'powerups', 'puntuaci√≥n'
    configuracion TEXT NOT NULL, -- JSON completo de la categor√≠a
    version INTEGER DEFAULT 1,
    activo BOOLEAN DEFAULT 1,
    actualizado_en DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

## üîÑ Plan de Migraci√≥n en Fases - CHECKLIST

### ‚úÖ FASE 1: Preparaci√≥n e Infraestructura (Prioridad Cr√≠tica)
**Objetivo**: Crear base SQLite sin romper sistema actual
**üìã Referencia**: [Progreso Refactorizaci√≥n - Fase 1](./refactorizacion_progreso.md#fase-1---urgente)

- [ ] **Crear DatabaseManager** (m√°ximo 150 l√≠neas)
  - [ ] Conexi√≥n SQLite con connection pooling
  - [ ] M√©todos base: conectar, desconectar, ejecutar_query
  - [ ] Manejo de transacciones
  - [ ] Logging de operaciones
  - [ ] Documentar en [FUNCIONES_DOCUMENTADAS.md](./FUNCIONES_DOCUMENTADAS.md)

- [ ] **Crear SchemaManager** (m√°ximo 150 l√≠neas)
  - [ ] Creaci√≥n autom√°tica de tablas
  - [ ] Migraciones de esquema
  - [ ] Validaci√≥n de integridad
  - [ ] Backup autom√°tico antes de cambios
  - [ ] Documentar en [FUNCIONES_DOCUMENTADAS.md](./FUNCIONES_DOCUMENTADAS.md)

- [ ] **Testing paralelo**
  - [ ] Base de datos de pruebas
  - [ ] Validaci√≥n de rendimiento vs pickle
  - [ ] Tests de integridad de datos
  - [ ] Actualizar [refactorizacion_progreso.md](./refactorizacion_progreso.md)

### üî• FASE 2: Migraci√≥n del ConfigManager (Dividir + Migrar)
**Objetivo**: Mover configuraciones JSON a SQLite
**üìã Referencia**: [Progreso Refactorizaci√≥n - Fase 2](./refactorizacion_progreso.md#fase-2---alta-prioridad)

- [ ] **Dividir ConfigManager** en m√≥dulos:
  - [ ] `config_loader.py` (m√°ximo 150 l√≠neas) - Carga desde archivos
  - [ ] `config_database.py` (m√°ximo 150 l√≠neas) - Interfaz SQLite
  - [ ] `config_validator.py` (m√°ximo 150 l√≠neas) - Validaciones
  - [ ] Actualizar [FUNCIONES_DOCUMENTADAS.md](./FUNCIONES_DOCUMENTADAS.md)

- [ ] **Migraci√≥n de datos**:
  - [ ] characters.json ‚Üí tabla personajes
  - [ ] enemies.json ‚Üí tabla enemigos
  - [ ] gameplay.json ‚Üí tabla configuracion_gameplay
  - [ ] audio.json, display.json, etc. ‚Üí tabla configuraciones
  - [ ] Proceso autom√°tico: `migrar_configuraciones_a_sqlite()`

- [ ] **Compatibilidad dual**:
  - [ ] Leer desde SQLite primero
  - [ ] Fallback a JSON si falla
  - [ ] Modo de migraci√≥n progresiva
  - [ ] Actualizar [refactorizacion_progreso.md](./refactorizacion_progreso.md)

### üìä FASE 3: Migraci√≥n del SaveManager (Dividir + Migrar)
**Objetivo**: Reemplazar pickle con SQLite manteniendo encriptaci√≥n
**üìã Referencia**: [Progreso Refactorizaci√≥n - Fase 3](./refactorizacion_progreso.md#fase-3---cr√≠tica)

- [ ] **Dividir SaveManager** en m√≥dulos:
  - [ ] `save_loader.py` (m√°ximo 150 l√≠neas) - Carga/guardado
  - [ ] `save_encryption.py` (m√°ximo 150 l√≠neas) - Encriptaci√≥n XOR
  - [ ] `save_database.py` (m√°ximo 150 l√≠neas) - Interfaz SQLite
  - [ ] `save_compatibility.py` (m√°ximo 150 l√≠neas) - Migraci√≥n desde pickle
  - [ ] Actualizar [FUNCIONES_DOCUMENTADAS.md](./FUNCIONES_DOCUMENTADAS.md)

- [ ] **Proceso de migraci√≥n**:
  - [ ] Migraci√≥n autom√°tica: `migrar_saves_pickle_a_sqlite()`
  - [ ] Mantener compatibilidad con saves antiguos
  - [ ] Encriptar campos sensibles en SQLite

- [ ] **Mejoras en funcionalidad**:
  - [ ] Guardado autom√°tico cada X minutos
  - [ ] Historial de partidas por slot
  - [ ] Estad√≠sticas detalladas por sesi√≥n
  - [ ] Backup autom√°tico preparado para futuro
  - [ ] Actualizar [refactorizacion_progreso.md](./refactorizacion_progreso.md)

### ‚ö° FASE 4: Migraci√≥n del GameState (Refactorizar + Integrar)
**Objetivo**: Dividir GameState e integrar con SQLite
**üìã Referencia**: [Progreso Refactorizaci√≥n - Archivos Cr√≠ticos](./refactorizacion_progreso.md#archivos-m√°s-cr√≠ticos)

- [ ] **Dividir GameState** en m√≥dulos:
  - [ ] `game_state_core.py` (m√°ximo 150 l√≠neas) - Estado b√°sico
  - [ ] `game_state_persistence.py` (m√°ximo 150 l√≠neas) - Guardado/carga
  - [ ] `game_state_statistics.py` (m√°ximo 150 l√≠neas) - Estad√≠sticas
  - [ ] Actualizar [FUNCIONES_DOCUMENTADAS.md](./FUNCIONES_DOCUMENTADAS.md)

- [ ] **Integraci√≥n con SQLite**:
  - [ ] Estado persistente en `partidas_guardadas`
  - [ ] Estad√≠sticas en tiempo real en `estadisticas_juego`
  - [ ] Sincronizaci√≥n autom√°tica
  - [ ] Finalizar actualizaci√≥n [refactorizacion_progreso.md](./refactorizacion_progreso.md)

## üìä Elementos a Migrar Identificados

### Desde SaveManager (pickle ‚Üí SQLite)
- **Datos de partida**: nivel, puntuaci√≥n, vidas, tiempo
- **Estado del jugador**: posici√≥n, inventario, mejoras
- **Configuraciones de partida**: dificultad, personaje seleccionado
- **Metadata**: timestamp, descripci√≥n, slot

### Desde ConfigManager (JSON ‚Üí SQLite)
- **Personajes**: stats, ataques, animaciones (characters.json)
- **Enemigos**: tipos, comportamientos, stats (enemies.json)
- **Gameplay**: niveles, combate, powerups (gameplay.json)
- **Audio**: vol√∫menes, efectos (audio.json)
- **Display**: resoluci√≥n, fullscreen (display.json)
- **Input**: controles, sensibilidad (input.json)

### Desde GameState (memoria ‚Üí SQLite + memoria)
- **Estado temporal**: score actual, vidas actuales
- **Estad√≠sticas**: enemigos eliminados, disparos, tiempo
- **Referencias**: entidades activas (no persistir)

## üîß Herramientas de Migraci√≥n

### Script de Migraci√≥n Autom√°tica
```python
# scripts/migrate_to_sqlite.py
def migrar_todo_a_sqlite():
    """Migraci√≥n completa del sistema actual a SQLite"""
    # Backup completo del estado actual
    crear_backup_completo()

    # Migrar configuraciones
    migrar_configuraciones()

    # Migrar saves existentes
    migrar_saves_existentes()

    # Validar integridad
    validar_migracion()

    # Generar reporte
    generar_reporte_migracion()
```

### Validaciones de Integridad
- Comparar datos migrados vs originales
- Verificar funcionalidad completa post-migraci√≥n
- Tests automatizados de carga/guardado
- Benchmark de rendimiento

## üìà Beneficios de la Migraci√≥n

### Inmediatos
- **Mejor rendimiento**: Queries espec√≠ficos vs carga completa
- **Menor uso de memoria**: Carga selectiva de datos
- **Integridad de datos**: Constraints y validaciones SQL
- **Backup incrementales**: Solo cambios recientes

### A Largo Plazo
- **Analytics avanzados**: Estad√≠sticas detalladas de juego
- **Sincronizaci√≥n**: M√∫ltiples dispositivos (futuro)
- **Modding**: API de base de datos para mods
- **Escalabilidad**: Preparado para multijugador

## üéØ Cronograma Estimado

| Fase | Duraci√≥n | Entregables |
|------|----------|-------------|
| Fase 1 | 2-3 d√≠as | DatabaseManager, SchemaManager, Tests |
| Fase 2 | 3-4 d√≠as | ConfigManager dividido + migrado |
| Fase 3 | 4-5 d√≠as | SaveManager dividido + migrado |
| Fase 4 | 2-3 d√≠as | GameState dividido + integrado |
| **Total** | **11-15 d√≠as** | **Sistema completo migrado** |

## üö® Consideraciones Cr√≠ticas

### Compatibilidad Durante Migraci√≥n
- **Dual-mode**: SQLite + fallback a sistema actual
- **Migraci√≥n gradual**: Funcionalidad por funcionalidad
- **Rollback**: Posibilidad de volver al sistema anterior

### Refactorizaci√≥n Simult√°nea
- **Prioridad 1**: Dividir archivos >150 l√≠neas
- **Prioridad 2**: Migrar datos a SQLite
- **Mantener**: Funcionalidad completa en todo momento

### Backup y Seguridad
- **Backup autom√°tico**: Antes de cada migraci√≥n
- **Encriptaci√≥n**: Mantener XOR para datos sensibles
- **Versionado**: SQLite schema con versiones

---

**‚úÖ PLAN LISTO PARA IMPLEMENTACI√ìN**

Este plan garantiza:
- ‚úÖ Refactorizaci√≥n de archivos cr√≠ticos (SaveManager 365‚Üí4x150 l√≠neas)
- ‚úÖ Migraci√≥n completa de persistencia a SQLite
- ‚úÖ Compatibilidad durante todo el proceso
- ‚úÖ Mejoras significativas en rendimiento y funcionalidad
- ‚úÖ Base s√≥lida para futuras caracter√≠sticas avanzadas

Siguiente paso: ¬øComenzamos con la Fase 1 (DatabaseManager + SchemaManager)?
